 

<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
	
<mapper namespace = "Order">


<resultMap id = "result" type = "map">
    <result property = "id" column = "ID"/>
    <result property = "amount" column = "AMOUNT"/>
    <collection property="orderLines" javaType="ArrayList" resultMap="olResultMap"/>
</resultMap>

<resultMap id = "olResultMap" type = "map">
    <result property="product"  column="PRODUCT"/>
    <result property="unitPrice"  column="UNIT_PRICE"/>
    <result property="quantity"  column="QUANTITY"/>
</resultMap>

<!-- the getAll query supports pagination. So make sure that there exists a count query
with the name getAll-count for such queries.
This is a complex query that supports where conditions on both orders and orderlines. However
the number of orders needs to be tracked (not the number of rows returned by the query)
Hence the count query does a count(order.id) rather than do a full count(*)
-->
<select id='getAll-count' resultType="int" >
	select count(distinct o.id) from orders o inner join order_lines ol
                on o.id = ol.order_id
    <where>
        <if test="amount != null" >
            AND amount between #{amount[0]} and #{amount[1]}
        </if>
        <if test="product != null">
            AND product in
            <foreach item="item" index="index" collection="product"
                     open="(" separator="," close=")">
                #{item}
            </foreach>
        </if>
  </where>
</select>

<!-- The getAll query supports an elaborate where clause. 
The conditional constructs ensure that the clause is constructed only if 
specific filters are passed. Notice that 
branch supports an IN clause and name supports a like clause. 
This information must be reflected in the column meta data in the definitions JSON that 
accompanies this mapper.
Since this query is sortable the orderby clause is important.
Since this query supports pagination the ${pagination} is mandatory. 
We also need the count query above
Make sure that sortable and paginated are set to true in the corresponding query definitions 
-->
<select id = "getAll" resultMap = "result">
    with u(id, amount) as (
       SELECT  id, amount
        FROM orders
        <where>
            <if test="amount != null" >
                AND amount between #{amount[0]} and #{amount[1]}
            </if>
        </where>
        ${pagination}
    )
        select u.id as id,
        u.amount as amount,
        ol.product as product,
        ol.unit_price as unit_price,
        ol.quantity as quantity
            from u
            inner join order_lines as ol on u.id = ol.order_id
         <where>
             <if test="product != null">
                 AND product in
                 <foreach item="item" index="index" collection="product"
                          open="(" separator="," close=")">
                     #{item}
                 </foreach>
             </if>
         </where>
        ${orderby}
</select>
</mapper>